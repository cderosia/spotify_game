<!--main_page.html-->

{% extends 'base.html' %}

{% block head %} 

<style>
   
    /* Center button styling */
    .center-button {
        position: absolute;
        top: 36%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5em;
    }
    #pausetimer {
        
        text-align: center;
        top: 38%;
        font-size: 1.5em;
    }
    .pausecount {
        top: 45%;
        text-align: center;
        font-size: 1.25em;
    }
    .button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%
    }
    .score {
        text-align: center;
        font-size: 1.5em;
    }
    .hamburger {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 30px;
        cursor: pointer;
        z-index: 2;
    }

    .hamburger-menu {
        position: fixed;
        top: 0;
        right: 0;
        width: 0;
        height: 100vh;
        background: #000000;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
    }

    .hamburger-menu a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        color: #ffffff;
        display: block;
        transition: 0.3s;
    }

    .hamburger-menu a:hover {
        color: #1DB954;
    }
    
    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 170px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 600%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        background-color: #1DB954;
        margin: auto;
        padding: 20px;
        border: 1px solid black;
        width: 80%;
        text-align: center;
        font-size: 2em;
    }

    /* The Close Button */
    .close {
    color: #302f2f;
    float: right;
    font-size: 28px;
    font-weight: bold;
    }

    .close:hover,
    .close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
    }



</style>

{% endblock %}

{% block body %} 


<button class="hamburger">&#9776;</button>

<nav class="hamburger-menu">
    <a href="{{ url_for('rules') }}">Rules</a>
    <a href="{{ url_for('logout') }}">Logout</a>
</nav>


<h1 style="text-align: center; font-size: 2.5em; margin-bottom: 0;">ðŸŽµQuizifyðŸŽµ</h1>
<br>


<div id = "song-count" style = "text-align: center; font-size: 1.5em;"></div>
<div id = "score" class = "score">Total Score: 0</div>

<div id="player">
    
    <div>
        <h2 style = "text-align: center" id = "elapsed-time">Elapsed Time: 0 seconds</h2>
    </div>
</div>

<button id="center-play-button" class="center-button" onclick="playPause()">Pause</button>
<br>
<br>

<br>
<br>

<div id="pausetimer"></div>
<br>
<div class = "pausecount" id = "pausecount"> </div>


<div class = "recap" id = "recap"></div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>


    // Declare functions in the global scope
    let playPause, nextTrack, processGuess;
    let currentTrack = 0;
    var tracks = {{ tracks|tojson|safe }};
    let song_num;
    let total_songs = tracks.length;
    let currentSongName, currentArtists;
  



    window.onSpotifyWebPlaybackSDKReady = () => {
        const token = '{{ access_token }}';
        const player = new Spotify.Player({
            name: 'Web Playback SDK Quick Start Player',
            getOAuthToken: cb => { cb(token); }
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => { 
            console.log(state); 

            // Start the timer if the song has started playing and the timer hasn't been started yet
            if (!state.paused && !isPlaying) {
                start = Date.now();
                timer = setInterval(updateElapsedTime, 1000);  // Update the elapsed time every second
                isPlaying = true;  // Set the play state to true
            }

            if(state.paused && state.position === 0 && state.restrictions.disallow_resuming_reasons) {
                setTimeout(nextTrack, 1000);  // delay the nextTrack function by 1 second
            }
        });



        // Ready
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            player.device_id = device_id;

            // Load the first track
            fetch('https://api.spotify.com/v1/me/player/play?device_id=' + device_id, {
                method: 'PUT',
                body: JSON.stringify({ uris: [tracks[currentTrack].uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
            .then(() => {
                console.log('Track loaded');
                currentSongName = tracks[currentTrack].name;
                currentArtists = tracks[currentTrack].artist;
            })
            .catch(console.error);

            song_num = 1;
            // display song number out of total
            document.getElementById('song-count').textContent = 'Song: 1/' + total_songs;
            document.getElementById('pausecount').textContent = 'Pauses left: 3';

            // Play next track
            document.getElementById('next-button').addEventListener('click', nextTrack);

            
           
        });

   
     
      



        // Connect to the player
        player.connect().then(success => {
            if (success) {
                console.log('Successfully connected to the player.');
            }
        }).catch(error => {
            console.error('Error connecting to the player:', error);
        });


        // Variables to track state
        let start, pauseStart, playTime = 0, pauseCount = 0, totalScore = 0;
        let isPlaying = false;
        // elapsed time timer
        let timer;
        // pause time timer
        let pauseTimer;
        let elapsedTime = 0; // Initial value

        // play/pause function
        playPause = function() {
            
            if (isPlaying) {
                pauseCount++;
                document.getElementById('pausecount').textContent = 'Pauses left: ' + (3 - pauseCount);
                // If limit reached, move to next track
                if (pauseCount >= 3) {
                    document.getElementById('pausecount').textContent = 'Pauses left: 0';
                    player.pause();
                    isPlaying = false;
                    clearInterval(timer);  // Stop updating the elapsed time every second
                    document.getElementById('center-play-button').disabled = true;
                    let remainingTime = 20;
                    pauseTimer = setInterval(() => {
                    remainingTime--;
                    document.getElementById('pausetimer').textContent = 'Remaining Time: ' + remainingTime + ' seconds';
                    if (remainingTime <= 0) {
                        clearInterval(pauseTimer);
                        document.getElementById('pausetimer').textContent = '';
                        
                        nextTrack();  // Assuming this function skips to the next track
                    }
                }, 1000);
                    
                    return;
                }
                player.pause();
                playTime += Date.now() - start;
                clearInterval(timer);  // Stop updating the elapsed time every second
                document.getElementById('center-play-button').textContent = 'Play';
                isPlaying = false;  // Set the play state to false

                // Clear existing pause timer
                if (pauseTimer) {
                    clearTimeout(pauseTimer);
                    pauseTimer = null;
                }
                // Start a new 20 seconds countdown timer
                let remainingTime = 20;
                pauseTimer = setInterval(() => {
                    remainingTime--;
                    document.getElementById('pausetimer').textContent = 'Remaining Time: ' + remainingTime + ' seconds';
                    if (remainingTime <= 0) {
                        clearInterval(pauseTimer);
                        document.getElementById('pausetimer').textContent = '';
                        playPause(); // Resume the song after 20 seconds
                    }
                }, 1000);
            } else {
                player.resume();
                start = Date.now();
                timer = setInterval(updateElapsedTime, 1000);  // Update the elapsed time every second
                document.getElementById('center-play-button').textContent = 'Pause';
                isPlaying = true;  // Set the play state to true

                // Clear countdown timer on resume
                if (pauseTimer) {
                    clearInterval(pauseTimer);
                    pauseTimer = null;
                    document.getElementById('pausetimer').textContent = '';
                   
                }
            }
        }



        // Play next track
        nextTrack = function() {
            //console.log(totalScore);

            modal.style.display = "none";
            song_num++;


            if (song_num == total_songs + 1) {
                window.location.href = 'result_page.html';
            }
           
            clearInterval(pauseTimer);
            pauseTimer = null;
            document.getElementById('pausetimer').textContent = '';
            
            document.getElementById('song-count').textContent = 'Song: '  + song_num + '/' + total_songs;
            document.getElementById('pausecount').textContent = 'Pauses left: 3';
            document.getElementById('center-play-button').disabled = false;
            
            
            

            if (currentTrack >= tracks.length - 1) {
                console.log('End of playlist');
                // open results_page.html
                return;
            }
            currentTrack = currentTrack + 1;

            if (currentTrack < tracks.length) {
                currentSongName = tracks[currentTrack].name;
                currentArtists = tracks[currentTrack].artist;
            }

            //console.log(tracks[currentTrack].name)
            //console.log(tracks[currentTrack].artist)
            console.log('Loading track', tracks[currentTrack].uri);

            fetch('https://api.spotify.com/v1/me/player/play?device_id=' + player.device_id, {
                method: 'PUT',
                body: JSON.stringify({ uris: [tracks[currentTrack].uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
            .then((response) => {
                if (!response.ok) {
                    return response.json().then(err => {throw err});
                }
                console.log('Next track loaded')
                // Track start time
                start = Date.now();
                // Reset pause count and play time
                pauseCount = 0;
                playTime = 0;
                // Enable pause button
                document.getElementById('play-button').disabled = false;
            })
            .catch(console.error);
        }

        


        function updateElapsedTime() {
            elapsedTime = Math.floor((Date.now() - start + playTime) / 1000);
            document.getElementById('elapsed-time').textContent = 'Elapsed Time: ' + elapsedTime + ' seconds';
        }


        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
            nextTrack();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                nextTrack();
            }
            
        }
        processGuess = function() {
            //console.log("process guess");
            let titleGuess = document.getElementById('title_guess').value;
            let artistGuess = document.getElementById('artist_guess').value;
            
            currentSongName = tracks[currentTrack].name;
            currentArtists = tracks[currentTrack].artist;

            
            
            evaluateGuess(titleGuess, artistGuess, currentSongName, currentArtists);

           
            
            // Clear the guess inputs
            document.getElementById('title_guess').value = '';
            document.getElementById('artist_guess').value = '';
           
        }

        
        // Function to evaluate guesses and assign points
        function evaluateGuess(titleGuess, artistGuess, correctTitle, correctArtists) {
            //console.log("evaluate guess");
            
            let elapsed = elapsedTime;

            // Prepare for checking guesses
            // Convert everything to lowercase to make comparison case insensitive
            // Remove everything inside parentheses or brackets
            // Remove everything after a hyphen
            // Remove all punctuation
            let titleGuessClean = titleGuess.toLowerCase().replace(/[\(\[].*?[\)\]]/g, '').replace(/-.*/g, '').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').trim();
            let artistGuessClean = artistGuess.toLowerCase().replace(/[\(\[].*?[\)\]]/g, '').replace(/-.*/g, '').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').trim();
            let correctTitleClean = correctTitle.toLowerCase().replace(/[\(\[].*?[\)\]]/g, '').replace(/-.*/g, '').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').trim();
            let correctArtistsClean = correctArtists.toLowerCase().replace(/[\(\[].*?[\)\]]/g, '').replace(/-.*/g, '').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').trim();

            // Check guesses
            let titleCorrect = titleGuessClean === correctTitleClean;
            let artistCorrect = artistGuessClean === correctArtistsClean;

            /*console.log("title guess clean: " + titleGuessClean);
            console.log("artist guess clean: " + artistGuessClean);
            console.log("correct title clean: " + correctTitleClean);
            console.log("correct artist clean: "+ correctArtistsClean);
            console.log("title correct:" + titleCorrect);
            console.log("artist correct: " + artistCorrect);
            */
            // Calculate score
            // score can be max 100
            
            let score;
            // guess before 2 seconds of playtime
            if (elapsed <= 2) {
                score = calculateScore(titleCorrect, artistCorrect, 100, 50, elapsedTime);
            } 
            // guess before 4 seconds of playtime
            else if (elapsed <= 4) {
                score = calculateScore(titleCorrect, artistCorrect, 90, 45, elapsedTime);
            } 
            // guess before 6 seconds of playtime
            else if (elapsed <= 6) {
                score = calculateScore(titleCorrect, artistCorrect, 70, 35, elapsedTime);
            } 
            // guess before 10 seconds of playtime
            else if (elapsed <= 10) {
                score = calculateScore(titleCorrect, artistCorrect, 40, 20, elapsedTime);
            } 
            // guess before 20 seconds of playtime
            else if (elapsed <= 20) {
                score = calculateScore(titleCorrect, artistCorrect, 20, 10, elapsedTime);
            } 
            // guess before 30 seconds of playtime
            else if (elapsed <= 30) {
                score = calculateScore(titleCorrect, artistCorrect, 10, 5, elapsedTime);
            } 
            else {
                // need to mention you didnt get either correct.
                score = calculateScore(titleCorrect, artistCorrect, 0, 0, elapsedTime);
            }
            //console.log(score);
            // Update total score
            

            totalScore += score;
            document.getElementById('score').textContent = "Total Score: " + totalScore;
            player.resume();
        }

        function calculateScore(titleCorrect, artistCorrect, bothCorrectScore, oneCorrectScore, time) {
            if (titleCorrect && artistCorrect && time <= 30) {
                // Show the modal with the result
                document.getElementById('modal-content').innerHTML = "Good Job! You correctly guess both the title and the artist of the song in " + time + " seconds!<br>"
                                                                     + "The song was " + tracks[currentTrack].name + " by " + tracks[currentTrack].artist + "<br>" 
                                                                     + "You get " + bothCorrectScore + " points.";
                modal.style.display = "block";
                //console.log("both correct");
                return bothCorrectScore;
            }
            else if (titleCorrect && time <= 30) {

                // Show the modal with the result
                document.getElementById('modal-content').innerHTML = "Almost! You correctly guessed the title but not the artist of the song in " + time + " seconds.<br>"
                                                                     + "The song was " + tracks[currentTrack].name + " by " + tracks[currentTrack].artist + "<br>" 
                                                                     + "You get " + oneCorrectScore + " points.";
                modal.style.display = "block";
                //console.log("just title correct");
                return oneCorrectScore;
            }
            else if (artistCorrect && time <= 30) {
                // Show the modal with the result
                document.getElementById('modal-content').innerHTML = "Almost! You correctly guessed the artist but not the title of the song in " + time + " seconds.<br>"
                                                                     + "The song was " + tracks[currentTrack].name + " by " + tracks[currentTrack].artist + "<br>" 
                                                                     + "You get " + oneCorrectScore + " points.";
                modal.style.display = "block";
                //console.log("just arist correct");
                return oneCorrectScore;
            }
            else if (time <= 30) {
                // Show the modal with the result
                document.getElementById('modal-content').innerHTML = "Sorry! You did not correctly guess either the title or the artist of the song in " + time + " seconds.<br>"
                                                                     + "The song was " + tracks[currentTrack].name + " by " + tracks[currentTrack].artist + "<br>" 
                                                                     + "You get " + 0 + " points.";
                modal.style.display = "block";
                //console.log("neither correct");
                return 0;
            }
            else {
                // Show the modal with the result
                document.getElementById('modal-content').innerHTML = "Sorry! You can only get points if you enter a guess before 30 seconds of the song has played.<br>"
                                                                     + "The song was " + tracks[currentTrack].name + " by " + tracks[currentTrack].artist + "<br>"  
                                                                     + "You get " + 0 + " points.";
                modal.style.display = "block";
            }
        }



    };
</script>

<br>
<br>
<br>

<form onsubmit="event.preventDefault(); processGuess();" style ="text-align: center">
    <label for="title_guess">Title Guess:</label><br>
    <input type="text" id="title_guess" name="title_guess"><br>
    <label for="artist_guess">Artist Guess:</label><br>
    <input type="text" id="artist_guess" name="artist_guess"><br><br>
    <input type="submit" value="Submit">
</form>



<br>
<div class="button-container">
    <button id="skip-button" class="skip-button" onclick="nextTrack()">Skip</button>
</div>
<br>
<br>
<br>
<div class = "last-song" id = "last-song"></div>


  <!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Your Guess Results</h2>
      <p id="modal-content"></p>
      <button id="next-song-button" onclick="nextTrack()">Next Song</button>
    </div>
  </div>
  



<script>
    document.querySelector('.hamburger').addEventListener('click', function() {
        var menu = document.querySelector('.hamburger-menu');
        if (menu.style.width === '0px' || menu.style.width === '') {
            menu.style.width = '250px';
        } else {
            menu.style.width = '0px';
        }
    });
</script>

{% endblock %}
