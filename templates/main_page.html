<!--main_page.html-->

{% extends 'base.html' %}

{% block head %} 

<style>
    .logout {
        text-align: right;
     
    }
    /* Center button styling */
    .center-button {
        position: absolute;
        top: 38%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5em;
    }
</style>

{% endblock %}

{% block body %} 
<div class = "logout">
    <a href="{{ url_for('logout') }}">Logout</a>
</div>

<h1 style="text-align: center; font-size: 2.5em; margin-bottom: 0;">ðŸŽµQuizifyðŸŽµ</h1>
<br>
<br>
<br>
<br>

<div id="player">
    
    
    <div>
        <h2 style = "text-align: center" id = "elapsed-time">Elapsed Time: 0 seconds</h2>
    </div>
</div>

<button id="center-play-button" class="center-button" onclick="playPause()">Pause</button>


<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>


    // Declare functions in the global scope
    let playPause, nextTrack;
    let currentTrack = 0;
    var tracks = {{ tracks|tojson|safe }};


    window.onSpotifyWebPlaybackSDKReady = () => {
        const token = '{{ access_token }}';
        const player = new Spotify.Player({
            name: 'Web Playback SDK Quick Start Player',
            getOAuthToken: cb => { cb(token); }
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => { 
            console.log(state); 

            // Start the timer if the song has started playing and the timer hasn't been started yet
            if (!state.paused && !isPlaying) {
                start = Date.now();
                timer = setInterval(updateElapsedTime, 1000);  // Update the elapsed time every second
                isPlaying = true;  // Set the play state to true
            }

            if(state.paused && state.position === 0 && state.restrictions.disallow_resuming_reasons) {
                setTimeout(nextTrack, 1000);  // delay the nextTrack function by 1 second
            }
        });



        // Ready
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            player.device_id = device_id;

            // Load the first track
            fetch('https://api.spotify.com/v1/me/player/play?device_id=' + device_id, {
                method: 'PUT',
                body: JSON.stringify({ uris: [tracks[currentTrack].uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
            .then(() => console.log('Track loaded'))
            .catch(console.error);

            

            // Play next track
            document.getElementById('next-button').addEventListener('click', nextTrack);
        });

   
     
      



        // Connect to the player
        player.connect().then(success => {
            if (success) {
                console.log('Successfully connected to the player.');
            }
        }).catch(error => {
            console.error('Error connecting to the player:', error);
        });


        // Variables to track state
        let start, pauseStart, playTime = 0, pauseCount = 0, totalScore = 0;
        let isPlaying = false;
        let timer;

       // Play next track
       
        nextTrack = function() {
            if (currentTrack >= tracks.length - 1) {
                console.log('End of playlist');
                return;
            }
            currentTrack = currentTrack + 1;

            console.log('Loading track', tracks[currentTrack].uri);

            fetch('https://api.spotify.com/v1/me/player/play?device_id=' + player.device_id, {
                method: 'PUT',
                body: JSON.stringify({ uris: [tracks[currentTrack].uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
            .then((response) => {
                if (!response.ok) {
                    return response.json().then(err => {throw err});
                }
                console.log('Next track loaded')
                // Track start time
                start = Date.now();
                // Reset pause count and play time
                pauseCount = 0;
                playTime = 0;
                // Enable pause button
                document.getElementById('play-button').disabled = false;
            })
            .catch(console.error);
        }

        playPause = function() {
            if (isPlaying) {
                pauseCount++;
                // If limit reached, disable pause button
                if (pauseCount >= 3) {
                    document.getElementById('center-play-button').disabled = true;
                    
                }
                player.pause();
                playTime += Date.now() - start;
                clearInterval(timer);  // Stop updating the elapsed time every second
                document.getElementById('center-play-button').textContent = 'Play';
                isPlaying = false;  // Set the play state to false
            } else {
                player.resume();
                start = Date.now();
                timer = setInterval(updateElapsedTime, 1000);  // Update the elapsed time every second
                document.getElementById('center-play-button').textContent = 'Pause';
                isPlaying = true;  // Set the play state to true
            }
        }


        function updateElapsedTime() {
            let elapsed = Math.floor((Date.now() - start + playTime) / 1000);
            document.getElementById('elapsed-time').textContent = 'Elapsed Time: ' + elapsed + ' seconds';
        }
        
        // Function to evaluate guesses and assign points
        function evaluateGuess(titleGuess, artistGuess, correctTitle, correctArtist) {
            // Calculate elapsed time in seconds
            let elapsed = playTime / 1000;
            // Check guesses
            let titleCorrect = titleGuess === correctTitle;
            let artistCorrect = artistGuess === correctArtist;
            // Calculate score
            // score can be max 100
            let score;
            
            // guess before 2 seconds of playtime
            if (elapsed <= 2) {
                if (titleCorrect && artistCorrect) {
                    score = 100;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 50;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 50;
                }
                else {
                    score = 0;
                }
            } 
            // guess before 4 seconds of playtime
            else if (elapsed <= 4) {
                if (titleCorrect && artistCorrect) {
                    score = 90;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 45;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 45;
                }
                else {
                    score = 0;
                }
            } 
            // guess before 6 seconds of playtime
            else if (elapsed <= 6) {
                if (titleCorrect && artistCorrect) {
                    score = 70;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 35;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 35;
                }
                else {
                    score = 0;
                }
            } 
            // guess before 10 seconds of playtime
            else if (elapsed <= 10) {
                if (titleCorrect && artistCorrect) {
                    score = 40;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 20;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 20;
                }
                else {
                    score = 0;
                }
            } 
            // guess before 20 seconds of playtime
            else if (elapsed <= 20) {
                if (titleCorrect && artistCorrect) {
                    score = 20;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 10;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 10;
                }
                else {
                    score = 0;
                }
            } 
            // guess before 30 seconds of playtime
            else if (elapsed <= 30) {
                if (titleCorrect && artistCorrect) {
                    score = 10;
                }
                else if (titleCorrect && !artistCorrect) {
                    score = 5;
                }
                else if (!titleCorrect && artistCorrect) {
                    score = 5;
                }
                else {
                    score = 0;
                }
            } 
            
            // Update total score
            totalScore += score;
        }


    };
</script>

<br>
<br>
<br>
<br>
<br>
<br>

<form action="/guesses" method="post" style ="text-align: center">
    <label for="title_guess">Title Guess:</label><br>
    <input type="text" id="title_guess" name="title_guess"><br>
    <label for="artist_guess">Artist Guess:</label><br>
    <input type="text" id="artist_guess" name="artist_guess"><br><br>
    <input type="submit" value="Submit">
</form>

{% if tracks %}
<ul>
    {% for track in tracks %}
    <li>{{ track['name'] }} by {{ track['artist'] }}</li>
{% endfor %}

</ul>
{% endif %}

{% endblock %}
